<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICS Azure Functions - Time-Triggered Functions Flow Diagram</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .diagram-container {
            padding: 40px;
            background: #f8f9fa;
        }

        .flow-diagram {
            display: flex;
            flex-direction: column;
            gap: 40px;
            position: relative;
        }

        .timer-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border-left: 5px solid #3498db;
        }

        .timer-header {
            display: flex;
            align-items: center;
            margin-bottom: 25px;
        }

        .timer-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 20px;
            color: white;
            font-size: 1.5em;
        }

        .timer-info h3 {
            color: #2c3e50;
            font-size: 1.4em;
            margin-bottom: 5px;
        }

        .timer-schedule {
            color: #7f8c8d;
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }

        .function-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .function-card {
            background: #fff;
            border: 2px solid #ecf0f1;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .function-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            border-color: #3498db;
        }

        .function-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #3498db, #2980b9);
        }

        .function-name {
            font-size: 1.2em;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .function-description {
            color: #7f8c8d;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .data-flow {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .data-source,
        .data-target {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 500;
        }

        .data-source {
            background: #e8f5e8;
            color: #27ae60;
            border: 1px solid #27ae60;
        }

        .data-target {
            background: #fef9e7;
            color: #f39c12;
            border: 1px solid #f39c12;
        }

        .external-systems {
            margin-top: 40px;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .external-systems h3 {
            color: #2c3e50;
            font-size: 1.5em;
            margin-bottom: 20px;
            text-align: center;
        }

        .systems-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .system-card {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .system-card:hover {
            border-color: #6c757d;
            background: #e9ecef;
        }

        .system-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #dddbdb, #f2f2f2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            color: white;
            font-size: 1.8em;
        }

        .system-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
        }

        .system-description {
            color: #6c757d;
            font-size: 0.9em;
        }

        .flow-arrows {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .arrow {
            position: absolute;
            width: 2px;
            background: #3498db;
            opacity: 0.6;
        }

        .arrow::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: -3px;
            width: 0;
            height: 0;
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            border-top: 8px solid #3498db;
        }

        .legend {
            margin-top: 30px;
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .legend h4 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .legend-items {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }

        .schedule-badge {
            display: inline-block;
            padding: 4px 8px;
            background: #3498db;
            color: white;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 500;
            margin-left: 10px;
        }

        /* Flowchart Section Styles */
        .flowchart-section {
            margin-top: 40px;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border-left: 5px solid #16a085;
        }

        .flowchart-section h3 {
            color: #2c3e50;
            font-size: 1.5em;
            margin-bottom: 25px;
            text-align: center;
        }

        .flowchart-container {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            border: 2px solid #dee2e6;
        }

        .flowchart-svg {
            width: 100%;
            height: auto;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 8px;
        }

        .flowchart-svg g {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .flowchart-svg g:hover {
            transform: scale(1.05);
        }

        .flowchart-svg text {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            pointer-events: none;
        }

        .flow-description {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .flow-step {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #ecf0f1;
            transition: all 0.3s ease;
        }

        .flow-step:hover {
            border-color: #3498db;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .step-number {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2em;
            flex-shrink: 0;
        }

        .step-content h4 {
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 1.1em;
        }

        .step-content p {
            color: #7f8c8d;
            line-height: 1.5;
            margin: 0;
        }

        /* Animation for SVG elements */
        @keyframes pulse {
            0% {
                opacity: 0.7;
            }

            50% {
                opacity: 1;
            }

            100% {
                opacity: 0.7;
            }
        }

        .flowchart-svg line {
            animation: pulse 2s infinite;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .function-grid {
                grid-template-columns: 1fr;
            }

            .systems-grid {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 2em;
            }

            .flow-description {
                grid-template-columns: 1fr;
            }

            .flowchart-svg {
                height: 400px;
            }

            .flowchart-container {
                padding: 10px;
            }
        }

        @media (max-width: 480px) {
            .flowchart-svg text {
                font-size: 8px;
            }
        }

        /* Bicep Infrastructure Section Styles */
        .bicep-container {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .bicep-overview {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            border-left: 4px solid #16a085;
        }

        .bicep-overview h4 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.3em;
        }

        .bicep-overview p {
            color: #7f8c8d;
            line-height: 1.6;
            margin: 0;
        }

        .bicep-category {
            margin-bottom: 35px;
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            border-left: 4px solid #3498db;
        }

        .category-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #ecf0f1;
        }

        .category-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            color: white;
        }

        .category-header h4 {
            color: #2c3e50;
            margin: 0;
            font-size: 1.4em;
            font-weight: 600;
        }

        .bicep-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }

        .bicep-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border: 2px solid #dee2e6;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .bicep-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(135deg, #3498db, #2980b9);
            transition: width 0.3s ease;
        }

        .bicep-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            border-color: #3498db;
        }

        .bicep-card:hover::before {
            width: 6px;
        }

        .bicep-card.core::before { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        .bicep-card.compute::before { background: linear-gradient(135deg, #f39c12, #e67e22); }
        .bicep-card.data::before { background: linear-gradient(135deg, #27ae60, #229954); }
        .bicep-card.messaging::before { background: linear-gradient(135deg, #9b59b6, #8e44ad); }
        .bicep-card.security::before { background: linear-gradient(135deg, #e67e22, #d35400); }
        .bicep-card.monitoring::before { background: linear-gradient(135deg, #16a085, #138d75); }

        .bicep-name {
            font-size: 1.1em;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .bicep-description {
            color: #7f8c8d;
            line-height: 1.5;
            margin-bottom: 15px;
            font-size: 0.95em;
        }

        .bicep-details {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .bicep-tag {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: 500;
        }

        /* Deployment Flow Styles */
        .deployment-flow {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin: 30px 0;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            border-left: 4px solid #16a085;
        }

        .deployment-flow h4 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.3em;
            text-align: center;
        }

        .flow-steps {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 15px;
        }

        .deploy-step {
            flex: 1;
            min-width: 180px;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            border: 2px solid #dee2e6;
            transition: all 0.3s ease;
        }

        .deploy-step:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            border-color: #16a085;
        }

        .deploy-step .step-number {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #16a085, #138d75);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2em;
            margin: 0 auto 15px;
        }

        .deploy-step h5 {
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 1em;
        }

        .deploy-step p {
            color: #7f8c8d;
            font-size: 0.9em;
            line-height: 1.4;
            margin: 0;
        }

        .flow-arrow {
            font-size: 1.5em;
            color: #16a085;
            font-weight: bold;
            flex-shrink: 0;
        }

        /* Bicep Commands Styles */
        .bicep-commands {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            border-left: 4px solid #e74c3c;
        }

        .bicep-commands h4 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.3em;
            text-align: center;
        }

        .command-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .command-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border: 2px solid #dee2e6;
            transition: all 0.3s ease;
        }

        .command-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            border-color: #e74c3c;
        }

        .command-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 12px;
            font-size: 1.1em;
        }

        .command-code {
            background: #2c3e50;
            border-radius: 8px;
            padding: 15px;
            overflow-x: auto;
        }

        .command-code code {
            color: #ecf0f1;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.9em;
            line-height: 1.4;
            white-space: nowrap;
        }

        /* Responsive Design for Bicep Section */
        @media (max-width: 768px) {
            .bicep-grid {
                grid-template-columns: 1fr;
            }

            .flow-steps {
                flex-direction: column;
            }

            .flow-arrow {
                transform: rotate(90deg);
                margin: 10px 0;
            }

            .command-grid {
                grid-template-columns: 1fr;
            }

            .deploy-step {
                min-width: auto;
            }

            .bicep-category {
                padding: 20px;
            }

            .category-header {
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }
        }

        @media (max-width: 480px) {
            .bicep-container {
                padding: 15px;
            }

            .bicep-card {
                padding: 15px;
            }

            .command-code code {
                font-size: 0.8em;
                white-space: pre-wrap;
                word-break: break-all;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>🕒 Time-Triggered Functions Flow Diagram</h1>
            <p>ICS Azure Functions Notification System - Automated Workflows</p>
        </div>

        <div class="diagram-container">
            <div class="flow-diagram">

                <!-- Every 2 Minutes Timer Functions -->
                <div class="timer-section">
                    <div class="timer-header">
                        <div class="timer-icon">⏰</div>
                        <div class="timer-info">
                            <h3>Every 2 Minutes Schedule</h3>
                            <div class="timer-schedule">0 */2 * * * * (CRON)</div>
                        </div>
                        <span class="schedule-badge">High Frequency</span>
                    </div>

                    <div class="function-grid">
                        <div class="function-card">
                            <div class="function-name">📊 dailyKpiMailer</div>
                            <div class="function-description">
                                Processes daily KPI data for fryer devices, merges with shift data, filters recipients
                                with good fryers, and sends personalized daily insight reports via email queue.
                            </div>
                            <div class="data-flow">
                                <span class="data-source">Cosmos DB (users, deviceKpi, shiftKpi)</span>
                                <span class="data-target">Email Queue</span>
                                <span class="data-target">SendGrid</span>
                            </div>
                        </div>

                        <div class="function-card">
                            <div class="function-name">🔄 fetchDevicesBackgroundJob</div>
                            <div class="function-description">
                                Fetches device data from Cumulocity IoT platform, filters devices based on user
                                mappings, and updates device information in Cosmos DB using bulk operations.
                            </div>
                            <div class="data-flow">
                                <span class="data-source">Cumulocity IoT API</span>
                                <span class="data-source">Cosmos DB (users)</span>
                                <span class="data-target">Cosmos DB (devices)</span>
                            </div>
                        </div>

                        <div class="function-card">
                            <div class="function-name">👥 fetchUserCumulocityToCosmos</div>
                            <div class="function-description">
                                Synchronizes user data from Cumulocity platform, maps roles to permissions, processes
                                notification preferences, and updates user profiles in Cosmos DB.
                            </div>
                            <div class="data-flow">
                                <span class="data-source">Cumulocity User API</span>
                                <span class="data-source">Cumulocity Inventory API</span>
                                <span class="data-target">Cosmos DB (users)</span>
                            </div>
                        </div>

                        <div class="function-card">
                            <div class="function-name">📧 sendingMailBackgroundJob</div>
                            <div class="function-description">
                                Processes email messages from Service Bus queue, retrieves email content from database,
                                sends emails via Microsoft Graph API, and updates user mail status.
                            </div>
                            <div class="data-flow">
                                <span class="data-source">Service Bus Queue</span>
                                <span class="data-source">Cosmos DB (emailData)</span>
                                <span class="data-target">Microsoft Graph API</span>
                                <span class="data-target">Cosmos DB (users)</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Weekly Timer Functions -->
                <div class="timer-section">
                    <div class="timer-header">
                        <div class="timer-icon">📅</div>
                        <div class="timer-info">
                            <h3>Weekly Schedule (Mondays)</h3>
                            <div class="timer-schedule">0 0 9 * * 1 (CRON)</div>
                        </div>
                        <span class="schedule-badge">Weekly</span>
                    </div>

                    <div class="function-grid">
                        <div class="function-card">
                            <div class="function-name">📈 weeklyKpiMailer</div>
                            <div class="function-description">
                                Similar to daily KPI mailer but processes weekly insights. Filters users with weekly
                                notification preferences and updated profiles, then sends comprehensive weekly reports.
                            </div>
                            <div class="data-flow">
                                <span class="data-source">Cosmos DB (users, deviceKpi, shiftKpi)</span>
                                <span class="data-target">Email Queue</span>
                                <span class="data-target">SendGrid</span>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Interactive Flowchart Section -->
            <div class="flowchart-section">
                <h3>🔄 Interactive Data Flow Chart</h3>
                <div class="flowchart-container">
                    <svg class="flowchart-svg" viewBox="0 0 1200 800" xmlns="http://www.w3.org/2000/svg">
                        <!-- Background -->
                        <defs>
                            <linearGradient id="bgGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#f8f9fa;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#e9ecef;stop-opacity:1" />
                            </linearGradient>

                            <!-- Arrow marker -->
                            <defs>
                                <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5"
                                    orient="auto">
                                    <polygon points="0 0, 10 3.5, 0 7" fill="#3498db" />
                                </marker>
                            </defs>
                        </defs>

                        <!-- External Systems (Top Row) -->
                        <g class="external-system" data-name="Cumulocity IoT">
                            <rect x="50" y="50" width="140" height="80" rx="10" fill="#e74c3c" opacity="0.9" />
                            <text x="120" y="85" text-anchor="middle" fill="white" font-size="12"
                                font-weight="bold">Cumulocity IoT</text>
                            <text x="120" y="100" text-anchor="middle" fill="white" font-size="10">Platform</text>
                        </g>

                        <g class="external-system" data-name="Timer Triggers">
                            <rect x="530" y="50" width="140" height="80" rx="10" fill="#9b59b6" opacity="0.9" />
                            <text x="600" y="85" text-anchor="middle" fill="white" font-size="12"
                                font-weight="bold">Timer Triggers</text>
                            <text x="600" y="100" text-anchor="middle" fill="white" font-size="10">CRON Schedules</text>
                        </g>

                        <!-- Azure Functions (Middle Row) -->
                        <g class="function-node" data-name="fetchUserCumulocityToCosmos">
                            <rect x="50" y="200" width="160" height="100" rx="15" fill="#3498db" opacity="0.9" />
                            <text x="130" y="225" text-anchor="middle" fill="white" font-size="11"
                                font-weight="bold">fetchUser</text>
                            <text x="130" y="240" text-anchor="middle" fill="white" font-size="11"
                                font-weight="bold">CumulocityToCosmos</text>
                            <text x="130" y="260" text-anchor="middle" fill="white" font-size="9">Every 2 min</text>
                            <text x="130" y="275" text-anchor="middle" fill="white" font-size="9">User Sync</text>
                        </g>

                        <g class="function-node" data-name="fetchDevicesBackgroundJob">
                            <rect x="250" y="200" width="160" height="100" rx="15" fill="#3498db" opacity="0.9" />
                            <text x="330" y="225" text-anchor="middle" fill="white" font-size="11"
                                font-weight="bold">fetchDevices</text>
                            <text x="330" y="240" text-anchor="middle" fill="white" font-size="11"
                                font-weight="bold">BackgroundJob</text>
                            <text x="330" y="260" text-anchor="middle" fill="white" font-size="9">Every 2 min</text>
                            <text x="330" y="275" text-anchor="middle" fill="white" font-size="9">Device Sync</text>
                        </g>

                        <g class="function-node" data-name="dailyKpiMailer">
                            <rect x="450" y="200" width="160" height="100" rx="15" fill="#27ae60" opacity="0.9" />
                            <text x="530" y="225" text-anchor="middle" fill="white" font-size="11"
                                font-weight="bold">dailyKpiMailer</text>
                            <text x="530" y="245" text-anchor="middle" fill="white" font-size="9">Every 2 min</text>
                            <text x="530" y="260" text-anchor="middle" fill="white" font-size="9">Daily Reports</text>
                        </g>

                        <g class="function-node" data-name="weeklyKpiMailer">
                            <rect x="650" y="200" width="160" height="100" rx="15" fill="#f39c12" opacity="0.9" />
                            <text x="730" y="225" text-anchor="middle" fill="white" font-size="11"
                                font-weight="bold">weeklyKpiMailer</text>
                            <text x="730" y="245" text-anchor="middle" fill="white" font-size="9">Weekly (Mon
                                9AM)</text>
                            <text x="730" y="260" text-anchor="middle" fill="white" font-size="9">Weekly Reports</text>
                        </g>

                        <g class="function-node" data-name="sendingMailBackgroundJob">
                            <rect x="850" y="200" width="160" height="100" rx="15" fill="#8e44ad" opacity="0.9" />
                            <text x="930" y="225" text-anchor="middle" fill="white" font-size="11"
                                font-weight="bold">sendingMail</text>
                            <text x="930" y="240" text-anchor="middle" fill="white" font-size="11"
                                font-weight="bold">BackgroundJob</text>
                            <text x="930" y="260" text-anchor="middle" fill="white" font-size="9">Every 2 min</text>
                            <text x="930" y="275" text-anchor="middle" fill="white" font-size="9">Email
                                Processing</text>
                        </g>

                        <!-- Database Layer (Bottom Row) -->
                        <g class="database-node" data-name="Cosmos DB">
                            <ellipse cx="200" cy="420" rx="80" ry="40" fill="#2c3e50" opacity="0.9" />
                            <text x="200" y="415" text-anchor="middle" fill="white" font-size="12"
                                font-weight="bold">Cosmos DB</text>
                            <text x="200" y="430" text-anchor="middle" fill="white" font-size="10">Database</text>
                        </g>

                        <g class="service-node" data-name="Service Bus">
                            <rect x="400" y="380" width="120" height="80" rx="10" fill="#16a085" opacity="0.9" />
                            <text x="460" y="410" text-anchor="middle" fill="white" font-size="12"
                                font-weight="bold">Service Bus</text>
                            <text x="460" y="425" text-anchor="middle" fill="white" font-size="10">Email Queue</text>
                        </g>

                        <g class="service-node" data-name="Microsoft Graph">
                            <rect x="600" y="380" width="120" height="80" rx="10" fill="#0078d4" opacity="0.9" />
                            <text x="660" y="405" text-anchor="middle" fill="white" font-size="11"
                                font-weight="bold">Microsoft</text>
                            <text x="660" y="420" text-anchor="middle" fill="white" font-size="11"
                                font-weight="bold">Graph API</text>
                            <text x="660" y="435" text-anchor="middle" fill="white" font-size="10">Email Service</text>
                        </g>

                        <!-- Data Flow Arrows -->
                        <!-- Cumulocity to Functions -->
                        <line x1="120" y1="130" x2="130" y2="200" stroke="#e74c3c" stroke-width="3"
                            marker-end="url(#arrowhead)" />
                        <line x1="150" y1="130" x2="330" y2="200" stroke="#e74c3c" stroke-width="3"
                            marker-end="url(#arrowhead)" />

                        <!-- Timer to Functions -->
                        <line x1="580" y1="130" x2="530" y2="200" stroke="#9b59b6" stroke-width="2"
                            marker-end="url(#arrowhead)" />
                        <line x1="620" y1="130" x2="730" y2="200" stroke="#9b59b6" stroke-width="2"
                            marker-end="url(#arrowhead)" />
                        <line x1="640" y1="130" x2="930" y2="200" stroke="#9b59b6" stroke-width="2"
                            marker-end="url(#arrowhead)" />

                        <!-- Functions to Database -->
                        <line x1="130" y1="300" x2="160" y2="380" stroke="#3498db" stroke-width="3"
                            marker-end="url(#arrowhead)" />
                        <line x1="330" y1="300" x2="240" y2="380" stroke="#3498db" stroke-width="3"
                            marker-end="url(#arrowhead)" />

                        <!-- Database to KPI Functions -->
                        <line x1="280" y1="420" x2="450" y2="250" stroke="#2c3e50" stroke-width="3"
                            marker-end="url(#arrowhead)" />
                        <line x1="280" y1="430" x2="650" y2="250" stroke="#2c3e50" stroke-width="3"
                            marker-end="url(#arrowhead)" />

                        <!-- KPI Functions to Service Bus -->
                        <line x1="530" y1="300" x2="460" y2="380" stroke="#27ae60" stroke-width="3"
                            marker-end="url(#arrowhead)" />
                        <line x1="730" y1="300" x2="480" y2="380" stroke="#f39c12" stroke-width="3"
                            marker-end="url(#arrowhead)" />

                        <!-- Service Bus to Email Function -->
                        <line x1="520" y1="420" x2="850" y2="250" stroke="#16a085" stroke-width="3"
                            marker-end="url(#arrowhead)" />

                        <!-- Email Function to Graph API -->
                        <line x1="930" y1="300" x2="660" y2="380" stroke="#8e44ad" stroke-width="3"
                            marker-end="url(#arrowhead)" />

                        <!-- Flow Labels -->
                        <text x="75" y="170" font-size="10" fill="#e74c3c" font-weight="bold">User/Device Data</text>
                        <text x="350" y="350" font-size="10" fill="#2c3e50" font-weight="bold">Store/Retrieve</text>
                        <text x="480" y="350" font-size="10" fill="#27ae60" font-weight="bold">Queue Email</text>
                        <text x="750" y="350" font-size="10" fill="#8e44ad" font-weight="bold">Send Email</text>

                    </svg>
                </div>

                <!-- Flow Description -->
                <div class="flow-description">
                    <div class="flow-step">
                        <div class="step-number">1</div>
                        <div class="step-content">
                            <h4>Data Ingestion</h4>
                            <p>Timer triggers activate functions every 2 minutes to fetch user and device data from
                                Cumulocity IoT platform</p>
                        </div>
                    </div>

                    <div class="flow-step">
                        <div class="step-number">2</div>
                        <div class="step-content">
                            <h4>Data Storage</h4>
                            <p>Fetched data is processed and stored in Azure Cosmos DB collections (users, devices, KPI
                                data)</p>
                        </div>
                    </div>

                    <div class="flow-step">
                        <div class="step-number">3</div>
                        <div class="step-content">
                            <h4>Report Generation</h4>
                            <p>KPI mailers retrieve data from Cosmos DB, process insights, and generate personalized
                                reports</p>
                        </div>
                    </div>

                    <div class="flow-step">
                        <div class="step-number">4</div>
                        <div class="step-content">
                            <h4>Email Queuing</h4>
                            <p>Generated reports are queued in Azure Service Bus for asynchronous processing</p>
                        </div>
                    </div>

                    <div class="flow-step">
                        <div class="step-number">5</div>
                        <div class="step-content">
                            <h4>Email Delivery</h4>
                            <p>Background job processes queue and sends emails via Microsoft Graph API to recipients</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- External Systems -->
            <div class="external-systems">
                <h3>🔗 External Systems & Dependencies</h3>
                <div class="systems-grid">
                    <div class="system-card">
                        <div class="system-icon">🌐</div>
                        <div class="system-name">Cumulocity IoT Platform</div>
                        <div class="system-description">Source for device data, user management, and inventory
                            information</div>
                    </div>

                    <div class="system-card">
                        <div class="system-icon">🗄️</div>
                        <div class="system-name">Azure Cosmos DB</div>
                        <div class="system-description">Primary database for users, devices, KPI data, shift data, and
                            email content</div>
                    </div>

                    <div class="system-card">
                        <div class="system-icon">🚌</div>
                        <div class="system-name">Azure Service Bus</div>
                        <div class="system-description">Message queue for asynchronous email processing</div>
                    </div>

                    <div class="system-card">
                        <div class="system-icon">📊</div>
                        <div class="system-name">Microsoft Graph API</div>
                        <div class="system-description">Email delivery service for sending reports and notifications
                        </div>
                    </div>

                    <div class="system-card">
                        <div class="system-icon">📧</div>
                        <div class="system-name">SendGrid (Alternative)</div>
                        <div class="system-description">Alternative email service for report delivery</div>
                    </div>
                </div>
            </div>

            <!-- Legend -->
            <!-- <div class="legend">
                <h4>📋 Legend</h4>
                <div class="legend-items">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #e8f5e8; border: 1px solid #27ae60;"></div>
                        <span>Data Source</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #fef9e7; border: 1px solid #f39c12;"></div>
                        <span>Data Target</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #3498db;"></div>
                        <span>High Frequency (Every 2 min)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #9b59b6;"></div>
                        <span>Weekly Schedule</span>
                    </div>
                </div>
            </div> -->

            <!-- Key Information -->
            <div class="legend">
                <h4>🔑 Key Information</h4>
                <div style="line-height: 1.8; color: #2c3e50;">
                    <p><strong>Data Flow Pattern:</strong> Cumulocity → Cosmos DB → Processing → Email Queue → Email
                        Delivery</p>
                    <p><strong>Good Fryers Filter:</strong> Functions filter recipients based on predefined
                        "GOOD_FRYERS" device IDs</p>
                    <p><strong>Notification Preferences:</strong> Users can configure daily, weekly, or monthly
                        notification preferences</p>
                    <p><strong>Asynchronous Processing:</strong> Email sending is decoupled using Service Bus for better
                        reliability</p>
                    <p><strong>Batch Processing:</strong> Device and user data are processed in batches of 20 for
                        optimal performance</p>
                </div>
            </div>

            <!-- Bicep Infrastructure Section -->
            <div class="flowchart-section">
                <h3>🏗️ Azure Infrastructure (Bicep Templates)</h3>
                
                <div class="bicep-container">
                    <div class="bicep-overview">
                        <h4>📋 Infrastructure as Code Overview</h4>
                        <p>Complete Azure infrastructure defined using Bicep templates for automated deployment and consistent environments.</p>
                    </div>

                    <!-- Core Infrastructure -->
                    <div class="bicep-category">
                        <div class="category-header">
                            <div class="category-icon">🏢</div>
                            <h4>Core Infrastructure</h4>
                        </div>
                        <div class="bicep-grid">
                            <div class="bicep-card core">
                                <div class="bicep-name">📄 main.bicep</div>
                                <div class="bicep-description">
                                    Master template orchestrating all infrastructure components with parameter validation and output management.
                                </div>
                                <div class="bicep-details">
                                    <span class="bicep-tag">Entry Point</span>
                                    <span class="bicep-tag">Orchestration</span>
                                </div>
                            </div>
                            
                            <div class="bicep-card core">
                                <div class="bicep-name">🏗️ resourceGroup.bicep</div>
                                <div class="bicep-description">
                                    Defines resource group with proper naming conventions, tags, and regional deployment settings.
                                </div>
                                <div class="bicep-details">
                                    <span class="bicep-tag">Foundation</span>
                                    <span class="bicep-tag">Naming</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Compute & Hosting -->
                    <div class="bicep-category">
                        <div class="category-header">
                            <div class="category-icon">⚡</div>
                            <h4>Compute & Hosting</h4>
                        </div>
                        <div class="bicep-grid">
                            <div class="bicep-card compute">
                                <div class="bicep-name">🔧 appServicePlan.bicep</div>
                                <div class="bicep-description">
                                    Consumption-based App Service Plan optimized for serverless Azure Functions with auto-scaling capabilities.
                                </div>
                                <div class="bicep-details">
                                    <span class="bicep-tag">Serverless</span>
                                    <span class="bicep-tag">Auto-Scale</span>
                                </div>
                            </div>
                            
                            <div class="bicep-card compute">
                                <div class="bicep-name">⚡ functionApp.bicep</div>
                                <div class="bicep-description">
                                    Azure Functions App with Node.js runtime, timer triggers, and integrated monitoring configuration.
                                </div>
                                <div class="bicep-details">
                                    <span class="bicep-tag">Node.js 18</span>
                                    <span class="bicep-tag">Timer Triggers</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Data & Storage -->
                    <div class="bicep-category">
                        <div class="category-header">
                            <div class="category-icon">🗄️</div>
                            <h4>Data & Storage</h4>
                        </div>
                        <div class="bicep-grid">
                            <div class="bicep-card data">
                                <div class="bicep-name">🌍 cosmosDb.bicep</div>
                                <div class="bicep-description">
                                    Cosmos DB with MongoDB API, automatic scaling, backup policies, and optimized for IoT data workloads.
                                </div>
                                <div class="bicep-details">
                                    <span class="bicep-tag">MongoDB API</span>
                                    <span class="bicep-tag">Auto-Scale</span>
                                </div>
                            </div>
                            
                            <div class="bicep-card data">
                                <div class="bicep-name">💾 storage.bicep</div>
                                <div class="bicep-description">
                                    Azure Storage Account for Functions runtime, logs, and temporary file storage with lifecycle management.
                                </div>
                                <div class="bicep-details">
                                    <span class="bicep-tag">Functions Storage</span>
                                    <span class="bicep-tag">Lifecycle</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Messaging & Communication -->
                    <div class="bicep-category">
                        <div class="category-header">
                            <div class="category-icon">📨</div>
                            <h4>Messaging & Communication</h4>
                        </div>
                        <div class="bicep-grid">
                            <div class="bicep-card messaging">
                                <div class="bicep-name">🚌 serviceBus.bicep</div>
                                <div class="bicep-description">
                                    Service Bus namespace with email queue, dead letter handling, and message retention policies.
                                </div>
                                <div class="bicep-details">
                                    <span class="bicep-tag">Message Queue</span>
                                    <span class="bicep-tag">Dead Letter</span>
                                </div>
                            </div>
                            
                            <div class="bicep-card messaging">
                                <div class="bicep-name">📧 emailService.bicep</div>
                                <div class="bicep-description">
                                    Microsoft Graph API permissions and service principal configuration for secure email delivery.
                                </div>
                                <div class="bicep-details">
                                    <span class="bicep-tag">Graph API</span>
                                    <span class="bicep-tag">OAuth2</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Security & Identity -->
                    <div class="bicep-category">
                        <div class="category-header">
                            <div class="category-icon">🔐</div>
                            <h4>Security & Identity</h4>
                        </div>
                        <div class="bicep-grid">
                            <div class="bicep-card security">
                                <div class="bicep-name">🆔 identity.bicep</div>
                                <div class="bicep-description">
                                    Managed Identity for Functions App with role assignments and secure access to Azure resources.
                                </div>
                                <div class="bicep-details">
                                    <span class="bicep-tag">Managed Identity</span>
                                    <span class="bicep-tag">RBAC</span>
                                </div>
                            </div>
                            
                            <div class="bicep-card security">
                                <div class="bicep-name">🔑 keyVault.bicep</div>
                                <div class="bicep-description">
                                    Azure Key Vault for secure storage of connection strings, API keys, and sensitive configuration.
                                </div>
                                <div class="bicep-details">
                                    <span class="bicep-tag">Secrets</span>
                                    <span class="bicep-tag">Encryption</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Monitoring & Observability -->
                    <div class="bicep-category">
                        <div class="category-header">
                            <div class="category-icon">📊</div>
                            <h4>Monitoring & Observability</h4>
                        </div>
                        <div class="bicep-grid">
                            <div class="bicep-card monitoring">
                                <div class="bicep-name">📈 appInsights.bicep</div>
                                <div class="bicep-description">
                                    Application Insights with custom dashboards, alerts, and performance monitoring for Functions.
                                </div>
                                <div class="bicep-details">
                                    <span class="bicep-tag">Telemetry</span>
                                    <span class="bicep-tag">Dashboards</span>
                                </div>
                            </div>
                            
                            <div class="bicep-card monitoring">
                                <div class="bicep-name">🚨 alerts.bicep</div>
                                <div class="bicep-description">
                                    Automated alerts for function failures, performance degradation, and resource utilization thresholds.
                                </div>
                                <div class="bicep-details">
                                    <span class="bicep-tag">Alerts</span>
                                    <span class="bicep-tag">Notifications</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Deployment Flow -->
                    <div class="deployment-flow">
                        <h4>🔄 Deployment Flow</h4>
                        <div class="flow-steps">
                            <div class="deploy-step">
                                <div class="step-number">1</div>
                                <div class="step-content">
                                    <h5>Parameter Validation</h5>
                                    <p>Validate deployment parameters and environment-specific configurations</p>
                                </div>
                            </div>
                            <div class="flow-arrow">→</div>
                            <div class="deploy-step">
                                <div class="step-number">2</div>
                                <div class="step-content">
                                    <h5>Core Infrastructure</h5>
                                    <p>Deploy resource group, storage, and foundational components</p>
                                </div>
                            </div>
                            <div class="flow-arrow">→</div>
                            <div class="deploy-step">
                                <div class="step-number">3</div>
                                <div class="step-content">
                                    <h5>Data Layer</h5>
                                    <p>Provision Cosmos DB, Service Bus, and data storage resources</p>
                                </div>
                            </div>
                            <div class="flow-arrow">→</div>
                            <div class="deploy-step">
                                <div class="step-number">4</div>
                                <div class="step-content">
                                    <h5>Security Setup</h5>
                                    <p>Configure managed identity, Key Vault, and access permissions</p>
                                </div>
                            </div>
                            <div class="flow-arrow">→</div>
                            <div class="deploy-step">
                                <div class="step-number">5</div>
                                <div class="step-content">
                                    <h5>Functions Deployment</h5>
                                    <p>Deploy Function App with timer triggers and monitoring</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Bicep Commands -->
                    <div class="bicep-commands">
                        <h4>⚡ Deployment Commands</h4>
                        <div class="command-grid">
                            <div class="command-card">
                                <div class="command-title">🚀 Full Deployment</div>
                                <div class="command-code">
                                    <code>az deployment group create --resource-group ics-functions-rg --template-file bicep/main.bicep --parameters @parameters/prod.json</code>
                                </div>
                            </div>
                            <div class="command-card">
                                <div class="command-title">🔍 Validation</div>
                                <div class="command-code">
                                    <code>az deployment group validate --resource-group ics-functions-rg --template-file bicep/main.bicep --parameters @parameters/prod.json</code>
                                </div>
                            </div>
                            <div class="command-card">
                                <div class="command-title">📋 What-If Analysis</div>
                                <div class="command-code">
                                    <code>az deployment group what-if --resource-group ics-functions-rg --template-file bicep/main.bicep --parameters @parameters/prod.json</code>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Add some interactive elements
        document.addEventListener('DOMContentLoaded', function () {
            const functionCards = document.querySelectorAll('.function-card');

            functionCards.forEach(card => {
                card.addEventListener('click', function () {
                    // Add a subtle animation on click
                    this.style.transform = 'scale(0.98)';
                    setTimeout(() => {
                        this.style.transform = 'translateY(-5px)';
                    }, 150);
                });
            });

            // Add interactivity to flowchart nodes
            const flowchartNodes = document.querySelectorAll('.flowchart-svg g');

            // Create tooltip element
            const tooltip = document.createElement('div');
            tooltip.style.cssText = `
                position: absolute;
                background: rgba(0,0,0,0.8);
                color: white;
                padding: 8px 12px;
                border-radius: 6px;
                font-size: 12px;
                pointer-events: none;
                z-index: 1000;
                opacity: 0;
                transition: opacity 0.3s ease;
                max-width: 200px;
                line-height: 1.4;
            `;
            document.body.appendChild(tooltip);

            // Tooltip content for each node
            const tooltipContent = {
                'fetchUserCumulocityToCosmos': 'Syncs user profiles, roles, and notification preferences from Cumulocity platform every 2 minutes',
                'fetchDevicesBackgroundJob': 'Fetches and updates device information including status, alarms, and metadata from IoT platform',
                'dailyKpiMailer': 'Processes daily KPI data, merges with shift information, and generates personalized reports for users',
                'weeklyKpiMailer': 'Creates comprehensive weekly insights and performance reports sent every Monday at 9 AM',
                'sendingMailBackgroundJob': 'Processes email queue and delivers reports via Microsoft Graph API with retry logic',
                'Cosmos DB': 'Primary database storing users, devices, KPI data, shift data, and email content with automatic scaling',
                'Service Bus': 'Message queue ensuring reliable, asynchronous email processing with dead letter handling',
                'Microsoft Graph': 'Microsoft 365 email service for secure, enterprise-grade email delivery',
                'Cumulocity IoT': 'IoT platform providing device management, user administration, and real-time data collection',
                'Timer Triggers': 'Azure Functions timer triggers using CRON expressions for scheduled execution'
            };

            flowchartNodes.forEach(node => {
                const nodeName = node.getAttribute('data-name');

                node.addEventListener('mouseenter', function (e) {
                    if (tooltipContent[nodeName]) {
                        tooltip.textContent = tooltipContent[nodeName];
                        tooltip.style.opacity = '1';

                        // Highlight the node
                        const rect = node.querySelector('rect, ellipse');
                        if (rect) {
                            rect.style.filter = 'brightness(1.2) drop-shadow(0 0 10px rgba(52, 152, 219, 0.5))';
                        }
                    }
                });

                node.addEventListener('mousemove', function (e) {
                    tooltip.style.left = (e.pageX + 10) + 'px';
                    tooltip.style.top = (e.pageY - 10) + 'px';
                });

                node.addEventListener('mouseleave', function () {
                    tooltip.style.opacity = '0';

                    // Remove highlight
                    const rect = node.querySelector('rect, ellipse');
                    if (rect) {
                        rect.style.filter = '';
                    }
                });

                // Add click effect for flowchart nodes
                node.addEventListener('click', function () {
                    // Create a ripple effect
                    const rect = node.querySelector('rect, ellipse');
                    if (rect) {
                        rect.style.transform = 'scale(0.95)';
                        setTimeout(() => {
                            rect.style.transform = 'scale(1)';
                        }, 150);
                    }
                });
            });

            // Add flow step interactions
            const flowSteps = document.querySelectorAll('.flow-step');
            flowSteps.forEach((step, index) => {
                step.addEventListener('mouseenter', function () {
                    // Highlight corresponding arrows in the flowchart
                    const lines = document.querySelectorAll('.flowchart-svg line');
                    lines.forEach((line, lineIndex) => {
                        if (lineIndex >= index * 2 && lineIndex < (index + 1) * 2) {
                            line.style.strokeWidth = '5';
                            line.style.filter = 'drop-shadow(0 0 5px rgba(52, 152, 219, 0.8))';
                        }
                    });
                });

                step.addEventListener('mouseleave', function () {
                    const lines = document.querySelectorAll('.flowchart-svg line');
                    lines.forEach(line => {
                        line.style.strokeWidth = '';
                        line.style.filter = '';
                    });
                });
            });

            // Add timestamp
            const header = document.querySelector('.header p');
            const now = new Date();
            header.innerHTML += ` | Generated: ${now.toLocaleDateString()} ${now.toLocaleTimeString()}`;

            // Add a subtle animation to the entire flowchart on load
            setTimeout(() => {
                const flowchartSection = document.querySelector('.flowchart-section');
                flowchartSection.style.opacity = '0';
                flowchartSection.style.transform = 'translateY(20px)';
                flowchartSection.style.transition = 'all 0.8s ease';

                setTimeout(() => {
                    flowchartSection.style.opacity = '1';
                    flowchartSection.style.transform = 'translateY(0)';
                }, 100);
            }, 500);
        });
    </script>
</body>

</html>